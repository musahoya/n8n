{% extends "base.html" %}

{% block title %}Step 5: ì´ë¯¸ì§€ ì¶”ê°€{% endblock %}

{% block content %}
<div class="step-container">
    <div class="progress-bar">
        <div class="progress-step completed">1. ì—…ì¢…</div>
        <div class="progress-step completed">2. ì£¼ì œ</div>
        <div class="progress-step completed">3. ì‘ì„±</div>
        <div class="progress-step completed">4. ê²€ìˆ˜</div>
        <div class="progress-step active">5. ì´ë¯¸ì§€</div>
        <div class="progress-step">6. ë°œí–‰</div>
    </div>

    <h2>ğŸ–¼ï¸ Step 5: ì´ë¯¸ì§€ ì¶”ê°€</h2>
    <p class="subtitle">ë¸”ë¡œê·¸ ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>

    <div class="image-prompt-section">
        <h3>ğŸ’¡ ì¶”ì²œ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸</h3>
        <p class="help-text">DALL-E, Midjourney ë“±ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í”„ë¡¬í”„íŠ¸ì…ë‹ˆë‹¤.</p>
        <div class="prompt-box">
            <pre>{{ prompt }}</pre>
            <button type="button" class="btn btn-secondary btn-small" onclick="copyPrompt()">
                ë³µì‚¬í•˜ê¸°
            </button>
        </div>
    </div>

    <div class="upload-section">
        <h3>ì´ë¯¸ì§€ ì—…ë¡œë“œ</h3>
        <form id="upload-form" enctype="multipart/form-data">
            <div class="upload-area" id="upload-area">
                <input type="file" id="image-input" name="image" accept="image/*" hidden>
                <div class="upload-placeholder" onclick="document.getElementById('image-input').click()">
                    <p>ğŸ“· í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ</p>
                    <p class="help-text">PNG, JPG, GIF, WEBP (ìµœëŒ€ 16MB)</p>
                </div>
                <div id="preview-container" style="display: none;">
                    <img id="image-preview" src="" alt="Preview">
                </div>
            </div>
            <button type="button" id="upload-btn" class="btn btn-primary" style="display: none;"
                    onclick="uploadImage()">
                ì—…ë¡œë“œ
            </button>
        </form>
    </div>

    <div id="upload-success" style="display: none;" class="success-message">
        <p>âœ… ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
    </div>

    <div class="action-buttons">
        <a href="{{ url_for('step6_final_preview') }}" class="btn btn-primary btn-large">
            ìµœì¢… ë¯¸ë¦¬ë³´ê¸° â†’
        </a>
        <p class="help-text">ì´ë¯¸ì§€ ì—†ì´ ì§„í–‰í•˜ë ¤ë©´ ë°”ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•˜ì„¸ìš”.</p>
    </div>
</div>

<script>
function copyPrompt() {
    const prompt = `{{ prompt }}`;
    navigator.clipboard.writeText(prompt);
    alert('í”„ë¡¬í”„íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

document.getElementById('image-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('image-preview').src = e.target.result;
            document.getElementById('preview-container').style.display = 'block';
            document.querySelector('.upload-placeholder').style.display = 'none';
            document.getElementById('upload-btn').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

async function uploadImage() {
    const formData = new FormData();
    const fileInput = document.getElementById('image-input');
    formData.append('image', fileInput.files[0]);

    try {
        const response = await fetch('{{ url_for("upload_image") }}', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            document.getElementById('upload-success').style.display = 'block';
            document.getElementById('upload-btn').disabled = true;
            document.getElementById('upload-btn').textContent = 'ì—…ë¡œë“œ ì™„ë£Œ';
        } else {
            alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + result.error);
        }
    } catch (error) {
        alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}
</script>
{% endblock %}
